//
// Created by Liu QiXing on 2018/10/26.
//
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>
#include <time.h>
#include <algorithm>
#include <cmath>

#include "trustnote-miner-deposit.h"



/**
 *	private member variables
 */
static STPOWDEPOSIT _arrPowDepositTable[ TRUSTNOTE_MINER_DEPOSIT_TABLE_LENGTH ] =
{
	//
	//  nShift          				    dblTimes		       dblDeposit
	//
	{        0,                                         0.000000,                    0.000000 },
	{        1,                                         0.988113,          33255946313.570831 },
	{        2,                                         2.952592,          37540128524.100410 },
	{        3,                                         6.858198,          41210955653.755264 },
	{        4,                                        14.622984,          44814000970.841057 },
	{        5,                                        30.060253,          48535333412.800926 },
	{        6,                                        60.751283,          52466708780.219704 },
	{        7,                                       121.768508,          56664747310.765854 },
	{        8,                                       243.077629,          61171087868.100685 },
	{        9,                                       484.253831,          66020957990.939056 },
	{       10,                                       963.739299,          71247324092.971191 },
	{       11,                                      1917.010440,          76883078233.825836 },
	{       12,                                      3812.220892,          82962273397.799515 },
	{       13,                                      7580.112838,          89520877431.578125 },
	{       14,                                     15071.106623,          96597280689.939804 },
	{       15,                                     29964.046414,         104232680045.692719 },
	{       16,                                     59572.888976,         112471404984.474670 },
	{       17,                                    118438.604553,         121361221734.212433 },
	{       18,                                    235470.280587,         130953635567.811340 },
	{       19,                                    468142.440622,         141304202974.009888 },
	{       20,                                    930720.914158,         152472860893.094818 },
	{       21,                                   1850379.046641,         164524277846.461639 },
	{       22,                                   3678763.048558,         177528230578.686890 },
	{       23,                                   7313796.481511,         191560009253.232239 },
	{       24,                                  14540652.571278,         206700854014.709076 },
	{       25,                                  28908456.858509,         223038425698.691315 },
	{       26,                                  57473270.862272,         240667313551.875488 },
	{       27,                                 114263340.016732,         259689582976.769989 },
	{       28,                                 227168397.061513,         280215366512.685730 },
	{       29,                                 451636373.524327,         302363501496.598206 },
	{       30,                                 897904005.605028,         326262218107.655029 },
	{       31,                                1785134347.238675,         352049881785.350464 },
	{       32,                                3549048246.719084,         379875794323.231262 },
	{       33,                                7055907851.014413,         409901058278.100647 },
	{       34,                               14027939925.743797,         442299509700.392334 },
	{       35,                               27889125355.441914,         477258724586.466919 },
	{       36,                               55446723980.507462,         514981104880.150879 },
	{       37,                              110234335460.917038,         555685050311.264648 },
	{       38,                              219158280996.507721,         599606222855.774048 },
	{       39,                              435711359155.110901,         646998911138.406738 },
	{       40,                              866243281492.088501,         698137502677.188110 },
	{       41,                             1722189258927.780029,         753318072493.704834 },
	{       42,                             3423906317006.695312,         812860097286.613892 },
	{       43,                             6807111591751.182617,         877108305092.885376 },
	{       44,                            13533304924960.468750,         946434671145.687622 },
	{       45,                            26905735233412.828125,        1021240571484.252563 },
	{       46,                            53491633600549.625000,        1101959106784.390381 },
	{       47,                           106347395469128.687500,        1189057609863.843262 },
	{       48,                           211430606279913.531250,        1283040351380.072266 },
	{       49,                           420347871000455.250000,        1384451459385.556152 },
	{       50,                           835698935757161.500000,        1493878069643.823486 },
	{       51,                          1661463657621084.000000,        1611953724945.482910 },
	{       52,                          3303176978554593.000000,        1739362043105.122070 },
	{       53,                          6567088062146120.000000,        1876840674875.542480 },
	{       54,                         13056111100306068.000000,        2025185574694.290283 },
	{       55,                         25957020135927400.000000,        2185255608988.661133 },
	{       56,                         51605481077833800.000000,        2357977528719.687988 },
	{       57,                        102597511707000608.000000,        2544351334954.453613 },
	{       58,                        203975414793477952.000000,        2745456068531.556152 },
	{       59,                        405526110213962048.000000,        2962456057339.927246 },
	{       60,                        806231605077362176.000000,        3196607657380.604980 },
	{       61,                       1602879283611761664.000000,        3449266526639.932617 },
	{       62,                       3186704641261519360.000000,        3721895473887.408203 },
	{       63,                       6335527930559618048.000000,        4016072927840.067871 },
	{       64,                      12595743464637898752.000000,        4333502075726.969238 },
	{       65,                      25041757398259073024.000000,        4676020724162.955078 },
	{       66,                      49785835616118644736.000000,        5045611939422.791016 },
	{       67,                      98979851476698038272.000000,        5444415528719.248047 },
	{       68,                     196783098588332752896.000000,        5874740428957.810547 },
	{       69,                     391226975109594349568.000000,        6339078074694.671875 },
	{       70,                     777803313147331346432.000000,        6840116822693.971680 },
	{       71,                    1546360635724295569408.000000,        7380757516597.496094 },
	{       72,                    3074339200281474498560.000000,        7964130281821.016602 },
	{       73,                    6112132771641813893120.000000,        8593612647913.994141 },
	{       74,                   12151608714730462511104.000000,        9272849103304.892578 },
	{       75,                   24158767466736345153536.000000,       10005772195647.480469 },
	{       76,                   48030352129782550888448.000000,       10796625299931.873047 },
	{       77,                   95489752483740950462464.000000,       11649987186179.974609 },
	{       78,                  189844388497665466302464.000000,       12570798528963.861328 },
	{       79,                  377432037539203162046464.000000,       13564390512228.218750 },
	{       80,                  750377422731914197860352.000000,       14636515695028.992188 },
	{       81,                 1491834875006616596381696.000000,       15793381316890.363281 },
	{       82,                 2965935843569660655042560.000000,       17041685235606.716797 },
	{       83,                 5896614682729051242627072.000000,       18388654705557.253906 },
	{       84,                11723134467645199158870016.000000,       19842088221046.429688 },
	{       85,                23306912379576604319285248.000000,       21410400666928.968750 },
	{       86,                46336768222566926285537280.000000,       23102672037926.105469 },
	{       87,                92122716829422119204945920.000000,       24928700008701.402344 },
	{       88,               183150342191986377484140544.000000,       26899056659058.875000 },
	{       89,               364123519144068685414531072.000000,       29025149682683.011719 },
	{       90,               723918588450566196355399680.000000,       31319288433798.527344 },
	{       91,              1439231730859197885877059584.000000,       33794755194137.363281 },
	{       92,              2861354865255556916046725120.000000,       36465882072824.531250 },
	{       93,              5688695912807542890872963072.000000,       39348133984406.820312 },
	{       94,             11309768523067465946938474496.000000,       42458198185438.992188 },
	{       95,             22485094300327926465944354816.000000,       45814080888013.710938 },
	{       96,             44702901271892232047459041280.000000,       49435211509594.625000 },
	{       97,             88874405214097763701121613824.000000,       53342555162723.695312 },
	{       98,            176692332654616228124862447616.000000,       57558734035879.789062 },
	{       99,            351284268442870311330355609600.000000,       62108158368242.328125 },
	{      100,            698392711225654105641291087872.000000,       67017167776659.375000 },
	{      101,           1388483410473143324194837102592.000000,       72314183753054.921875 },
	{      102,           2760461485595633754117096079360.000000,       78029874215183.703125 },
	{      103,           5488108504559079765418677633024.000000,       84197331063426.031250 },
	{      104,          10910978151653057544656670162944.000000,       90852261771616.343750 },
	{      105,          21692254103021768598238493933568.000000,       98033196121150.718750 },
	{      106,          43126645615982096068146980978688.000000,      105781709275293.750000 },
	{      107,          85740631344873427462535612727296.000000,      114142662485208.562500 },
	{      108,         170462037063535319580793869697024.000000,      123164462821316.593750 },
	{      109,         338897738727549881995325201186816.000000,      132899343433742.421875 },
	{      110,         673766894336940628322209618722816.000000,      143403665964456.531250 },
	{      111,        1339524511461552368780671742640128.000000,      154738246861979.562500 },
	{      112,        2663125677274661856482658741125120.000000,      166968709487898.093750 },
	{      113,        5294593949028450813210193037361152.000000,      180165864053769.968750 },
	{      114,       10526249408468127694103528152760320.000000,      194406117588123.375000 },
	{      115,       20927370007214161040606129043800064.000000,      209771916307119.218750 },
	{      116,       41605969840171383793738093378404352.000000,      226352222950052.531250 },
	{      117,       82717356540478565496013671500873728.000000,      244243031843302.343750 },
	{      118,      164451426065266472705852806923288576.000000,      263547924674775.468750 },
	{      119,      326947966738581881810413214536564736.000000,      284378670196587.562500 },
	{      120,      650009401025619743598459675706654720.000000,      306855871328057.562500 },
	{      121,     1292291937571563225273564262276530176.000000,      331109663405519.750000 },
	{      122,     2569221997831754618642469244849094656.000000,      357280467621582.750000 },
	{      123,     5107902852467539934653159261362716672.000000,      385519804015991.187500 },
	{      124,    10155086470637708343178174295804215296.000000,      415991168725032.312500 },
	{      125,    20189456261156323624307473639771471872.000000,      448870980568459.500000 },
	{      126,    40138914158901038024861121692500492288.000000,      484349602454351.187500 },
	{      127,    79800684526377181013075806723868983296.000000,      522632443515490.187500 }
};





/**
 *	initialize deposit table
 *
 *	@return	{int}
 */
int TrustNoteDeposit::initDepositTable()
{
	int i;
	int nShift;

	for ( i = 0; i < TRUSTNOTE_MINER_DEPOSIT_TABLE_LENGTH; i ++ )
	{
		nShift	= i;

		_arrPowDepositTable[ i ].nShift		= nShift;
		_arrPowDepositTable[ i ].dblTimes	= pow( 1988.1107 / 999.999, (double)nShift ) - 1;
		_arrPowDepositTable[ i ].dblDeposit	= 10000.0 * 1000.0 * 1000.0 * ( 3.33 * pow( _arrPowDepositTable[ i ].dblTimes, 0.1107 ) );

		if ( _arrPowDepositTable[ i ].dblDeposit > TRUSTNOTE_MINER_DEPOSIT_MAX_NOTES )
		{
			break;
		}
	}

	//	...
	return 0;
}


/**
 *	get deposit table
 *
 *	@return	{STPOWDEPOSIT *}
 */
STPOWDEPOSIT * TrustNoteDeposit::getDepositTable()
{
	return _arrPowDepositTable;
}


/**
 *	get shift by deposit
 *
 *	@param	{double}	dblDeposit	in Notes
 *	@return	{int}
 */
int TrustNoteDeposit::getShiftByDeposit( double dblDeposit )
{
	int nRet;
	int i;

	//	...
	nRet = TRUSTNOTE_MINER_DEPOSIT_DEFAULT_SHIFT;

	for ( i = TRUSTNOTE_MINER_DEPOSIT_TABLE_LENGTH - 1; i >= 0; i -- )
	{
		if ( dblDeposit >= _arrPowDepositTable[ i ].dblDeposit )
		{
			nRet = _arrPowDepositTable[ i ].nShift;
			break;
		}
	}

	return nRet;
}


/**
 *	check if a shift value is valid
 *
 *	@param	{int}	nShift
 *	@return	{boolean}
 */
bool TrustNoteDeposit::isValidShift( int nShift )
{
	return ( nShift >= TRUSTNOTE_MINER_DEPOSIT_MIN_SHIFT && nShift <= TRUSTNOTE_MINER_DEPOSIT_MAX_SHIFT );
}
